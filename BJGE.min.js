function GameEngine(t,i=24){return this.rooms=[],this.sprites=[],this.resources=[],this.objects=[],this.sounds=[],this.tiles=[],this.backgrounds=[],this.currentRoom=-1,this.status="active",this.fps=i,this.timing={fps:i,currentTime:0,lastUpdate:0},this.debug={showCBoxes:!1},this.registry=0,this.generateID=function(){return this.registry++,this.registry},this.getEngineResources=function(t=-1){let i=this.rooms.concat(this.sprites).concat(this.resources).concat(this.objects).concat(this.sounds).concat(this.tiles).concat(this.backgrounds);return-1===t?i:i.filter(i=>"number"==typeof t?i.id===t:i.name===t)},this.getSprite=function(t=""){return"object"==typeof t?t:this.sprites.filter(i=>"number"==typeof t?i.id===t:i.name===t)[0]},this.keysHeld={},this.checkKey=function(t){return void 0!==this.keysHeld[t]&&this.keysHeld[t]},this.update=function(t){let i=this;if(requestAnimationFrame(function(){i.update()}),this.timing.currentTime=Date.now(),!(this.timing.currentTime-this.timing.lastUpdate>1e3/this.timing.fps||0===this.timing.lastUpdate))return!1;this.timing.lastUpdate=this.timing.currentTime;let e=this.rooms[this.currentRoom];if(void 0===e)return!1;if(e.draw(),e.roomObjects.forEach(t=>{t.active&&(t.builtInPhysics(),"function"==typeof t.onstep&&t.onstep(),t.visible&&("function"==typeof t.ondraw&&t.ondraw(),"object"!=typeof t.sprite||t.getOutsideView()||t.sprite.draw(t.x,t.y),this.debug.showCBoxes&&this.engine.ctx.strokeRect(-e.view.x+t.x+t.collisionBox[0],-e.view.y+t.y+t.collisionBox[1],t.collisionBox[2],t.collisionBox[3])))}),this.debug.drawGrid)for(let t=0;t<e.width;t+=e.gridX)for(let i=0;i<e.height;i+=e.gridY)this.engine.ctx.strokeRect(-e.view.x+t,-e.view.y+i,e.gridX,e.gridY)},this.addRoom=function(t){if("object"!=typeof t)return!1;this.rooms.push(t)},this.getRoom=function(t){this.rooms.forEach(i=>{if(i["string"==typeof t?"name":"id"]===t)return i})},this.getCurrentRoom=function(){return void 0!==this.rooms[this.currentRoom]&&this.rooms[this.currentRoom]},this.setCurrentRoom=function(t){let i=-1;if("number"==typeof t&&"object"==typeof this.rooms[t])i=t;else if("string"==typeof t)for(let e=0;e<this.rooms.length;e++)this.rooms[e].name===t&&(i=e);else if("object"==typeof t)for(let e=0;e<this.rooms.length;e++)this.rooms[e].id===t.id&&(i=e);return-1!==i&&(this.currentRoom=i,this.rooms[this.currentRoom].roomStart(),!0)},this.importTiles=function(t){let i=this.getCurrentRoom();t.forEach(t=>{for(let i=0;i<this.sprites.length;i++){let e=this.sprites[i],s=t.sprite,h=["fileName","sheetX","sheetY","sheetWidth","sheetHeight","drawWidth","drawHeight"],r=!0;if(h.forEach(t=>{e[t]!==s[t]&&(r=!1)}),r){t.sprite=this.sprites[i];break}}t.sprite=new Sprite(t.sprite.fileName,t.sprite.sheetX,t.sprite.sheetY,t.sprite.sheetWidth,t.sprite.sheetHeight,t.sprite.drawWidth,t.sprite.drawHeight),this.addSprite(t.sprite),i.tiles.push(t)})},this.begin=function(){let t=this;requestAnimationFrame(function(){t.update()})},this.getIntersecting=function(t,i,e,s,h,r,o,n){return(t>=h&&t<=o||e>=h&&e<=o||e<=h&&e>=o||t<=h&&e>=o)&&(i>=r&&i<=n||s>=r&&s<=n||i<=r&&s>=n||i<=r&&s>=n)},this.mDistance=function(t,i,e,s){return Math.abs(t-e)+Math.abs(i-s)},this.distance=function(t,i,e,s,h=!0){return h?Math.sqrt(Math.abs(t-e)**2+Math.abs(i-s)**2):this.mDistance(t,i,e,s)},this.getPointDirection=function(t,i){var e=.01745329251*-t;let s=Math.cos(e)*i,h=Math.sin(e)*i;return[s,h]},this.getPointDir=this.getPointDirection,this.snap=function(t,i){return Math.round(t/i)*i},this.random=function(t=0,i=1){return Math.random()*(i-t)+t},this.irandom=function(t=0,i=1){return Math.floor(Math.random()*(i+1-t))+t},this.engine={},this.engine.canvas="object"==typeof t?t:document.querySelector(t),this.engine.ctx=this.engine.canvas.getContext("2d"),this.engine.workingCanvas=document.createElement("canvas"),this.engine.workingCtx=this.engine.workingCanvas.getContext("2d"),this.engine.localFilter=function(t){return"string"==typeof t&&t.replace("file:///","").replace(/\\/g,"/")},this.engine.ris=function(t,i){return void 0!==t?t:i},this.engine.importResource=function(t,i=!1){let e;t=GAME_ENGINE_INSTANCE.engine.localFilter(t);try{if(!i){let s=GAME_ENGINE_INSTANCE.resources.filter(i=>i.src===t);s.length>0?e=s[0]:i=!0}if(i){if(null!=t.match(/\.(png|tiff|bmp|jpg|jpeg|gif|jpg2000|jpeg2000|raw|webm|svg|tga|apng|ico)/i))e=document.createElement("img"),e.src=t;else{if(null==t.match(/\.(wav|mp3|ogg|midi|mid|flac|wma|m3u)/i))return!1;e=new Audio(t)}GAME_ENGINE_INSTANCE.resources.push(e)}return e}catch(t){return console.error("Engine Error",t),!1}},window.GAME_ENGINE_INSTANCE=this,this}function Background(t,i=-1,e=!0){let s="object"==typeof t;return this.color=s?t.color:t,this.colour=this.color,this.sprite=s?t.sprite:i,this.tiled=s?t.tiled:e,this.draw=function(){let t=GAME_ENGINE_INSTANCE.getCurrentRoom(),i=GAME_ENGINE_INSTANCE.engine,e=i.ctx.fillStyle;if(i.ctx.fillStyle=this.color,i.ctx.fillRect(0,0,t.width,t.height),i.ctx.fillStyle=e,"object"==typeof this.sprite)if(this.tiled)for(let i=0;i<t.width;i+=this.sprite.drawWidth)for(let e=0;e<t.height;e+=this.sprite.drawHeight)this.sprite.draw(i,e);else this.sprite.draw(0,0)},GAME_ENGINE_INSTANCE.backgrounds.push(this),this}function GameObject(t,i=0,e=0,s=-1,h=-1,r=-1,o=-1,n=!0,a=!0,c=!1,l=0){let u="object"==typeof t;return this.name=u?t.name:t,this.x=u?t.x:i,this.y=u?t.y:e,this.xstart=i,this.ystart=e,this.xprevious=i,this.yprevious=e,this.sprite=u?t.sprite:s,this.depth=l,this.visible=u?t.visible:n,this.active=u?t.active:a,this.onstep=u?t.step:h,this.ondraw=u?t.draw:r,this.ondestroy=u?t.destroy:o,this.hspeed=0,this.vspeed=0,this.friction=0,this.gravity=0,this.gravityDirection=0,this.fallSpeed=0,this.terminalVelocity=24,this.collisionBox=!1===c?"object"==typeof this.sprite?[0,0,this.sprite.drawWidth,this.sprite.drawHeight]:[0,0,16,16]:c,this.id=GAME_ENGINE_INSTANCE.generateID(),this.getCoordinates=function(t=!0){let i={x1:this.x+this.collisionBox[0],y1:this.y+this.collisionBox[1],x2:this.x+this.collisionBox[0]+this.collisionBox[2],y2:this.y+this.collisionBox[1]+this.collisionBox[3]};return t?i:[i.x1,i.y1,i.x2,i.y2]},this.getCoords=this.getCoordinates,this.builtInPhysics=function(){let t=this.getCollisions(this.hspeed,0,!0),i=this.getCollisions(0,this.vspeed,!0);t.length>0&&0!==this.hspeed?(this.x=this.hspeed<0?t[0].getCoords().x2-this.collisionBox[0]+1:t[0].getCoords().x1-(this.collisionBox[2]-this.collisionBox[0])-1+2*(this.x-this.getCoords().x1),this.hspeed=0):this.x+=this.hspeed,i.length>0&&0!==this.vspeed?(this.y=this.vspeed<0?i[0].getCoords().y2-this.collisionBox[1]+1:i[0].getCoords().y1-(this.collisionBox[3]+this.collisionBox[1])-1,this.vspeed=0):this.y+=this.vspeed,this.x!=this.xprevious&&(this.xprevious=this.x),this.y!=this.yprevious&&(this.yprevious=this.y);let e=GAME_ENGINE_INSTANCE.getPointDir(this.gravityDirection,this.fallSpeed),s=this.getCollisions(e[0],e[1],!0);0!=this.gravity?s.length<=0?(this.fallSpeed=Math.min(this.terminalVelocity,this.fallSpeed+this.gravity),this.x+=e[0],this.y+=e[1],this.hspeed+=e[0],this.vspeed+=e[1],this.hspeed=Math.abs(this.hspeed)<=this.friction?0:this.hspeed-this.friction/4*(Math.abs(this.hspeed)/this.hspeed),this.vspeed=Math.abs(this.vspeed)<=this.friction?0:this.vspeed-this.friction/4*(Math.abs(this.vspeed)/this.vspeed)):(this.moveContactSolid(this.gravityDirection,-1),this.fallSpeed=0,this.hspeed=Math.abs(this.hspeed)<=this.friction?0:this.hspeed-this.friction*(Math.abs(this.hspeed)/this.hspeed),this.vspeed=Math.abs(this.vspeed)<=this.friction?0:this.vspeed-this.friction*(Math.abs(this.vspeed)/this.vspeed)):(this.fallSpeed=0,this.hspeed=Math.abs(this.hspeed)<=this.friction?0:this.hspeed-this.friction*(Math.abs(this.hspeed)/this.hspeed),this.vspeed=Math.abs(this.vspeed)<=this.friction?0:this.vspeed-this.friction*(Math.abs(this.vspeed)/this.vspeed))},this.moveContactSolid=function(t,i=-1){-1===i&&(i=Math.max(GAME_ENGINE_INSTANCE.getCurrentRoom().height,GAME_ENGINE_INSTANCE.getCurrentRoom().width));let e=[this.x,this.y];for(let s=0;s<i;s++){let i=GAME_ENGINE_INSTANCE.getPointDir(t,s);if(this.getCollisions(i[0],i[1],!0).length>0)return this.x+=e[0],this.y+=e[1],s;e=i}return!1},this.getCollisions=function(t=0,i=0,e=!1){let s=GAME_ENGINE_INSTANCE.getCurrentRoom(),h=this.getCoords(),r=h.x1+t,o=h.x2+t,n=h.y1+i,a=h.y2+i;return s.getAllAt(r,n,e,o-r,a-n,[this.id])},this.getOutsideRoom=function(){let t=GAME_ENGINE_INSTANCE.getCurrentRoom(),i=this.getCoords();return i.x2<0||i.x1>t.width||i.y2<0||i.y1>t.height},this.getOutsideView=function(){let t=GAME_ENGINE_INSTANCE.getCurrentRoom(),i=t.view,e=this.getCoords();return e.x2<i.x||e.x1>i.x+i.width||e.y2<i.y||e.y1>i.y+i.height},this.generateDepthPath=function(t,i,e,s,h,r=[]){let o=[[t+","+i]];for(let t=0;t<90;t++){let t=o[o.length-1],i=h[t];if(void 0!==i){if(t==e+","+s)return[!0,o];let n=i.exits.filter(t=>-1===r.indexOf(t)&&h[t].dist<=i.dist&&-1===o.indexOf(t));if(!(n.length>0))return[!1,o];{let t=n.sort((t,i)=>h[t].dist-h[i].dist)[0];o.push(t)}}}return[!1,"panicked"]},this.generatePath=function(t,i,e,s){function h(t,i=0,e=-1){if(this.path=-1==e?t:t.concat(e),this.weight=i,-1!==e){let t=e.split(",");this.weight+=l[t[0]+","+t[1]]}return this}let r=Math.round(this.x/e),o=Math.round(this.y/s),n=Math.round(t/e),a=Math.round(i/s),c=GAME_ENGINE_INSTANCE.getCurrentRoom(),l={};for(let t in c.mapNodes){let i=t.split(",");l[t]={exits:Array.from(c.mapNodes[t].exits),dist:Math.abs(i[0]-n)+Math.abs(i[1]-a)}}let u=[new h([r+","+o])],d=[],p={path:-1,weight:-1},f=!1;for(let t=0;t<50;t++){let t=[],i={dist:9999999,index:-1};for(let e=0;e<u.length;e++){let s=u[e],r=s.path;if(r.length<p.path.length||r.length===p.path.length&&r.weight<p.weight||-1===p.path){let e=r[r.length-1];if(void 0!==l[e]){if(e===n+","+a){p=s,f=!1;break}l[e].exits.forEach(e=>{if(void 0!==l[e]&&-1===r.indexOf(e)&&-1===d.indexOf(e)){f=!0;let o=new h(r,s.weight,e);t.push(o),l[e].dist<i.dist&&(i.dist=l[e].dist,i.index=t.length-1),d.push(e)}})}}}if(-1!==i.index){let e=t[i.index],s=e.path[e.path.length-1].split(","),h=this.generateDepthPath(s[0],s[1],n,a,l,d);h[0]&&(t[i.index].path=e.path.concat(h[1].slice(1)))}if(!f)break;u=Array.from(t)}return this.path={path:Array.isArray(p.path)?p.path.slice(1):-1,gridX:e,gridY:s},p},this.path={path:[],gridX:32,gridY:32},this.wrap=function(t=!0,i=!0){let e=0,s=this.x+this.collisionBox[0],h=this.x+this.collisionBox[0]+this.collisionBox[2],r=this.y+this.collisionBox[1],o=this.y+this.collisionBox[1]+this.collisionBox[3];return t&&(s>GAME_ENGINE_INSTANCE.getCurrentRoom().width?this.x=-(this.collisionBox[0]+this.collisionBox[2]):h<0&&(this.x=GAME_ENGINE_INSTANCE.getCurrentRoom().width),e++),i&&(r>GAME_ENGINE_INSTANCE.getCurrentRoom().height?this.y=-(this.collisionBox[1]+this.collisionBox[3]):o<0&&(this.y=GAME_ENGINE_INSTANCE.getCurrentRoom().height),e++),e},this.pathStep=function(t=0){if(0===this.path.path.length||-1===this.path.path)return!1;let i=this.path.path,e=i[0].split(","),s=[e[0]*this.path.gridX,e[1]*this.path.gridY];0===t?(this.x=s[0],this.y=s[1]):this.moveTowardsPoint(s[0],s[1],t);let h=Math.sqrt(Math.abs(this.x-s[0])**2+Math.abs(this.y-s[1])**2);return(h<t||0==t)&&(this.path.path=this.path.path.slice(1)),0===this.path.path.length&&(this.x=s[0],this.y=s[1]),!0},this.moveTowardsPoint=function(t,i,e){let s=Math.sqrt((t-this.x)**2+(i-this.y)**2);return s>0&&(this.x+=(t-this.x)*e/s,this.y+=(i-this.y)*e/s,!0)},this.moveInDirection=function(t,i){let e=GAME_ENGINE_INSTANCE.pointDirection(t,i);return this.x=this.x+e[0],this.y=this.y+e[1],!0},this.setDepth=function(t=0){this.depth=t;let i=GAME_ENGINE_INSTANCE.getCurrentRoom();i&&i.sortDepth()},this.setSprite=function(t,i=-1,e=-1,s=!1,h=!1,r=!1,o=!1){return t=GAME_ENGINE_INSTANCE.getSprite(t),void 0===t?(console.warn("EngineResource Sprite not found matching ",t),!1):((this.sprite.name!=t.name||o)&&(this.sprite=t,this.sprite.setFrame(-1===i?this.sprite.frameX:i,-1===e?this.sprite.frameY:e),this.sprite.speed=!1===s?this.sprite.speed:s,this.sprite.scaleX=!1===h?this.sprite.scaleX:h,this.sprite.scaleY=!1===r?this.sprite.scaleY:r),!0)},this.destroy=function(){let t=GAME_ENGINE_INSTANCE.getCurrentRoom(),i=t.roomObjects.filter(t=>t.id!==this.id);return t.roomObjects=i,"function"==typeof this.ondestroy&&this.ondestroy(),!0},this.deactivate=function(){return this.active=!1},this.activate=function(){return this.active=!0},this.snapToGrid=function(t=-1,i=-1){return-1===t&&(t=GAME_ENGINE_INSTANCE.getCurrentRoom().gridX),-1===i&&(i=GAME_ENGINE_INSTANCE.getCurrentRoom().gridY),t<=0||i<=0?(console.error("Must snap to at least 1x1 grid."),!1):(this.x=Math.round(this.x/t)*t,this.y=Math.round(this.y/i)*i,!0)},GAME_ENGINE_INSTANCE.objects.push(this),this}function Instance(t,i=25,e=!0){let s="object"==typeof t?t:GAME_ENGINE_INSTANCE.getEngineResources(t)[0];try{if(i<=0)throw"Recursed too many times.";for(let t in s){let e=s[t];if("number"==typeof e&&(this[t]=Number(e)),"string"==typeof e&&(this[t]=String(e)),"function"!=typeof e&&"boolean"!=typeof e||(this[t]=e),"object"==typeof e)if(Array.isArray(e)){this[t]=[];for(let s=0;s<e.length;s++)this[t][s]="object"==typeof e[s]?new Instance(e[s],i-1,!1):e[s]}else this[t]=-1!==String(e.__proto__).indexOf("HTML")?e:new Instance(e,i-1,!1)}}catch(i){return console.error("Value copy failed",t,i),null}return e&&(this.id=GAME_ENGINE_INSTANCE.generateID()),this}function Sprite(t,i,e=0,s=0,h=16,r=16,o=16,n=16,a=1,c=!1,l=-1){let u="object"==typeof t,d=GAME_ENGINE_INSTANCE.engine;return this.name=t,this.fileName=u?t.fileName:i,this.resource=d.importResource(this.fileName,c),this.frameX=0,this.frameY=0,this.speed=a,this.sheetX=u?t.sheetX:e,this.sheetY=u?t.sheetY:s,this.sheetWidth=u?t.sheetWidth:h,this.sheetHeight=u?t.sheetHeight:r,this.drawWidth=u?t.drawWidth:o,this.drawHeight=u?t.drawHeight:n,this.animated=Array.isArray(this.sheetX)||Array.isArray(this.sheetY),this.framesX=Array.isArray(this.sheetX)?this.sheetX.length:0,this.framesY=Array.isArray(this.sheetY)?this.sheetY.length:0,this.frames=Math.max(this.framesX,this.framesY),this.frame=0,this.onanimationend=l,this.scaleX=1,this.scaleY=1,this.workingResource=this.resource,this.lastDrawScaled=!1,this.id=GAME_ENGINE_INSTANCE.generateID(),Array.isArray(this.sheetX)&&Array.isArray(this.sheetY)&&this.sheetX.length!==this.sheetY.length&&console.warn("Warning: (X,Y) frame count mistmatch in "+this.name+"."),this.draw=function(t,i){let e=GAME_ENGINE_INSTANCE.engine,s=GAME_ENGINE_INSTANCE.getCurrentRoom();try{if(t-s.view.x<=s.view.width+this.drawWidth&&i-s.view.y<=s.view.height+this.drawHeight){let h=Array.isArray(this.sheetX)?this.sheetX[Math.round(this.frameX)]:this.sheetX,r=Array.isArray(this.sheetY)?this.sheetY[Math.round(this.frameY)]:this.sheetY;1==this.scaleX&&1==this.scaleY||(e.ctx.save(),e.ctx.translate(t-s.view.x,i-s.view.y),e.ctx.scale(this.scaleX,this.scaleY),t=s.view.x,i=s.view.y),e.ctx.drawImage(this.resource,h,r,this.sheetWidth,this.sheetHeight,(t-s.view.x)*(this.scaleX/Math.abs(this.scaleX)),(i-s.view.y)*(this.scaleY/Math.abs(this.scaleY)),this.drawWidth*this.scaleX,this.drawHeight*this.scaleY),1==this.scaleX&&1==this.scaleY||e.ctx.restore(),this.animated&&this.speed>0&&((Array.isArray(this.sheetX)&&this.frameX+this.speed>=this.sheetX.length-1||!Array.isArray(this.sheetX))&&(Array.isArray(this.sheetY)&&this.frameY+this.speed>=this.sheetY.length-1||!Array.isArray(this.sheetY))&&"function"==typeof this.onanimationend&&this.onanimationend(),Array.isArray(this.sheetX)&&(this.frameX=this.frameX+this.speed>this.sheetX.length-1?0:this.frameX+this.speed),Array.isArray(this.sheetY)&&(this.frameY=this.frameY+this.speed>this.sheetY.length-1?0:this.frameY+this.speed),this.frame=this.frameX+this.frameY)}}catch(t){console.error("Sprite error",t)}},this.setFrame=function(t=0,i=0){return this.frameX=t,this.frameY=i,this.frame=t+i,this.frame},GAME_ENGINE_INSTANCE.sprites.push(this),this}function Room(t,i=1280,e=720,s=32,h=32,r=[],o=[],n=new Background("gray")){let a="object"==typeof t,c=GAME_ENGINE_INSTANCE.engine;return this.name=a?t.name:t,this.width=a?t.width:i,this.height=a?t.height:e,this.background=a?t.background:n,this.gridX=s,this.gridY=h,this.roomObjects=a?t.roomObjects:r,this.tiles=a?t.tiles:o,this.view={x:0,y:0,width:this.width,height:this.height,obj:!1},this.id=GAME_ENGINE_INSTANCE.generateID(),this.roomStart=function(){this.roomObjects.forEach(t=>{"function"==typeof t.onroomstart&&t.onroomstart()})},this.sortDepth=function(){let t=this.roomObjects.sort((t,i)=>i.depth-t.depth);return this.roomObjects=t,!0},this.addObject=function(t,i=!1,e=!0,s=!1){return this.roomObjects.push(i?Object.assign({},t):t),e&&this.sortDepth(),!0},this.getObject=function(t=-1){if("object"==typeof t)return t;for(let i=0;i<this.roomObjects.length;i++){let e=this.roomObjects[i];if(e["string"==typeof t?"name":"id"]===t)return e}return!1},this.getObjects=function(t=-1){let i=[];return this.roomObjects.forEach(e=>{Array.isArray(t)?-1===t.indexOf(e.name)&&-1===t.indexOf(e.id)||i.push(e):e["string"==typeof t?"name":"id"]===t&&i.push(e)}),i},this.getTilesAt=function(t,i,e=!1,s=1,h=1){let r=[];return this.tiles.forEach(o=>{(o.solid&&e||!e)&&GAME_ENGINE_INSTANCE.getIntersecting(o.x,o.y,o.x+o.sprite.drawWidth-1,o.y+o.sprite.drawHeight-1,t,i,t+s,i+h)&&r.push(o)}),r},this.getObjectsAt=function(t,i,e=!1,s=1,h=1,r=[]){Array.isArray(r)||(r=[r]);let o=[];return this.roomObjects.forEach(n=>{let a=n.collisionBox;-1==r.indexOf(n.id)&&-1==r.indexOf(n.name)&&n.active&&(n.solid&&e||!e)&&GAME_ENGINE_INSTANCE.getIntersecting(n.x+a[0],n.y+a[1],n.x+a[0]+a[2],n.y+a[1]+a[3],t,i,t+s,i+h)&&o.push(n)}),o},this.getAllAt=function(t,i,e=!1,s=1,h=1,r=[]){return this.getObjectsAt(t,i,e,s,h,r).concat(this.getTilesAt(t,i,e,s,h))},this.checkEmpty=function(t,i,e=!1,s=1,h=1){return 0===this.getObjectsAt(t,i,e,s,h).concat(this.getTilesAt(t,i,e,s,h)).length},this.draw=function(){if("string"==typeof this.view.obj||"object"===this.view.obj){let t=this.getObject(this.view.obj);"object"==typeof t&&(this.view.x=Math.min(Math.max(t.x-this.view.width/2,0),this.width-this.view.width),this.view.y=Math.min(Math.max(t.y-this.view.height/2,0),this.height-this.view.height))}if("string"==typeof this.background){let t=c.ctx.fillStyle;c.ctx.fillStyle=this.background,c.ctx.fillRect(0,0,this.width,this.height),c.ctx.fillStyle=t}else"object"==typeof this.background&&this.background.draw();return this.tiles.length>0&&this.tiles.forEach(t=>{"object"==typeof t&&t.sprite.draw(t.x,t.y)}),!0},this.generateNodes=function(){let t={},i=this.gridX,e=this.gridY,s=Math.round(this.width/this.gridX),h=Math.round(this.height/this.gridY),r=[];for(let o=0;o<s;o++){r[o]=[];for(let s=0;s<h;s++){r[o][s]=this.getAllAt(o*i,s*e,!0).length>0?"A":" ";let h={exits:[]};for(let t=-1;t<2;t++)for(let r=-1;r<2;r++)0==this.getAllAt(1+(o+t)*i,1+(s+r)*e,!0,0,0).length&&o+t>=0&&s+r>=0&&(t+o+r+s!=0||t+o==0||r+s==0)&&h.exits.push(o+t+","+(s+r));t[o+","+s]=h}}this.mapNodes=t,this.map=r},this.generateNodes(),GAME_ENGINE_INSTANCE.rooms.push(this),this}function Tile(t,i=new Sprite,e=0,s=0,h=!1,r=[]){return this.name=t,this.sprite=i,this.x=e,this.y=s,this.solid=h,this.properties=r,this.id=GAME_ENGINE_INSTANCE.generateID(),this.destroy=function(){console.log(this,this.id);let t=GAME_ENGINE_INSTANCE.getCurrentRoom().tiles.filter(t=>t.id!==this.id);return GAME_ENGINE_INSTANCE.getCurrentRoom().tiles=t,!0},GAME_ENGINE_INSTANCE.tiles.push(this),this}function Sound(t,i,e=1,s=!1){let h=GAME_ENGINE_INSTANCE.engine;return this.name=t,this.fileName=i,this.resource=h.importResource(i,s),this.resource.volume=e,this.prevVolume=e,this.play=function(t=this.prevVolume){return this.prevVolume=this.resource.volume,this.resource.volume=t,this.resource.play(),this.resource.volume=this.prevVolume,!0},this.loop=function(){return this.resource.loop=!0,this.resource.play(),!0},this.pause=function(){return this.resource.pause(),this.resource.loop=!1,!0},this.stop=function(){return this.pause(),this.resource.currentTime=0,!0},this.seek=function(t=0){return this.resource.currentTime=t,!0},this.setVolume=function(t=1){return this.resource.volume=t,!0},this.mute=function(){return this.prevVolume=this.resource.volume,this.resource.volume=0,!0},this.unmute=function(){return 0===this.resource.volume&&(this.resource.volume=this.prevVolume,!0)},this.setSpeed=function(t=1){this.resource.playbackRate=t},this.id=GAME_ENGINE_INSTANCE.generateID(),GAME_ENGINE_INSTANCE.sounds.push(this),this}["keydown","keyup","keypress","mousedown","mouseup","mousemove","contextmenu"].forEach(t=>{window.addEventListener(t,i=>{if("undefined"==typeof GAME_ENGINE_INSTANCE)return!1;void 0!==i.type&&(GAME_ENGINE_INSTANCE.keysHeld[i.key]="keypress"==i.type||"keydown"==i.type);let e=GAME_ENGINE_INSTANCE.getCurrentRoom();"object"==typeof e&&e.roomObjects.forEach(e=>{if("function"==typeof e["on"+t]){let s=(-1!==i.type.indexOf("mouse")||-1!==i.type.indexOf("context"))&&GAME_ENGINE_INSTANCE.getIntersecting(e.x+e.collisionBox[0],e.y+e.collisionBox[1],e.x+e.collisionBox[0]+e.collisionBox[2],e.y+e.collisionBox[1]+e.collisionBox[3],i.x,i.y,i.x,i.y);e["on"+t](i,s)}})})});